# EVENT-TICKETING-PLATFORM

*Your Gateway to Unforgettable Events*

![license](https://img.shields.io/badge/license-ISC-blue)
![last commit](https://img.shields.io/badge/last%20commit-today-green)
![TypeScript](https://img.shields.io/badge/TypeScript-5.2.2-blue?logo=typescript)
![languages](https://img.shields.io/badge/languages-TypeScript%20%7C%20JavaScript-yellow)

*Built with the tools and technologies:*

![Express](https://img.shields.io/badge/Express-4.18.2-black?logo=express&logoColor=white)
![MongoDB](https://img.shields.io/badge/MongoDB-6.2.0-green?logo=mongodb&logoColor=white)
![Mongoose](https://img.shields.io/badge/Mongoose-8.0.0-red?logo=mongoose)
![Node.js](https://img.shields.io/badge/Node.js-20.9.0-green?logo=node.js&logoColor=white)
![React](https://img.shields.io/badge/React-18.2.0-blue?logo=react&logoColor=white)
![TypeScript](https://img.shields.io/badge/TypeScript-5.2.2-blue?logo=typescript&logoColor=white)
![Vite](https://img.shields.io/badge/Vite-7.1.1-purple?logo=vite&logoColor=white)
![Tailwind CSS](https://img.shields.io/badge/Tailwind_CSS-3.3.5-38B2AC?logo=tailwind-css&logoColor=white)
![Axios](https://img.shields.io/badge/Axios-1.11.0-purple?logo=axios)
![PayOS](https://img.shields.io/badge/PayOS-2.0.3-orange?logo=paypal)
![Zustand](https://img.shields.io/badge/Zustand-5.0.9-purple?logo=zustand)
![React Query](https://img.shields.io/badge/React%20Query-5.90.15-orange?logo=react-query)
![Cloudinary](https://img.shields.io/badge/Cloudinary-1.41.0-blue?logo=cloudinary)

---

## üìã T·ªïng Quan D·ª± √Ån

H·ªá th·ªëng b√°n v√© s·ª± ki·ªán to√†n di·ªán ƒë∆∞·ª£c x√¢y d·ª±ng v·ªõi MERN Stack (MongoDB, Express, React, Node.js) v√† TypeScript. H·ªá th·ªëng h·ªó tr·ª£ qu·∫£n l√Ω s·ª± ki·ªán t·ª´ A-Z v·ªõi ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng t·ª´ t√¨m ki·∫øm, ƒë·∫∑t v√©, thanh to√°n, check-in ƒë·∫øn qu·∫£n l√Ω t·ªï ch·ª©c v√† ph√¢n quy·ªÅn.

### ‚ú® T√≠nh NƒÉng Ch√≠nh

#### üîê X√°c Th·ª±c & Qu·∫£n L√Ω Ng∆∞·ªùi D√πng
- **ƒêƒÉng k√Ω/ƒêƒÉng nh·∫≠p**: H·ªó tr·ª£ Local, Google, Facebook OAuth
- **Qu√™n m·∫≠t kh·∫©u**: Kh√¥i ph·ª•c m·∫≠t kh·∫©u qua OTP/Email
- **Qu·∫£n l√Ω h·ªì s∆°**: C·∫≠p nh·∫≠t avatar, th√¥ng tin c√° nh√¢n, ƒë·ªïi m·∫≠t kh·∫©u
- **V√≠ s·ªë d∆∞**: Qu·∫£n l√Ω v√≠, l·ªãch s·ª≠ giao d·ªãch, r√∫t ti·ªÅn

#### üîç Kh√°m Ph√° S·ª± Ki·ªán
- **T√¨m ki·∫øm & L·ªçc**: T√¨m s·ª± ki·ªán theo t√™n, ng√†y, ƒë·ªãa ƒëi·ªÉm, th·ªÉ lo·∫°i (h·ªó tr·ª£ t√¨m kh√¥ng d·∫•u)
- **Xem chi ti·∫øt**: Th√¥ng tin s·ª± ki·ªán, ngh·ªá sƒ©, th·ªùi gian, s∆° ƒë·ªì gh·∫ø
- **G·ª£i √Ω c√° nh√¢n h√≥a**: "C√≥ th·ªÉ b·∫°n th√≠ch" d·ª±a tr√™n l·ªãch s·ª≠ mua v√©
- **Xem ch·ªó ng·ªìi 360 ƒë·ªô**: M√¥ ph·ªèng g√≥c nh√¨n th·ª±c t·∫ø t·ª´ gh·∫ø (VR/AI)

#### üé´ ƒê·∫∑t V√© & Thanh To√°n
- **Ch·ªçn & Gi·ªØ gh·∫ø**: Kh√≥a gh·∫ø trong 5-10 ph√∫t khi thanh to√°n (Race Condition handling)
- **√Åp d·ª•ng m√£ gi·∫£m gi√°**: Ki·ªÉm tra v√† tr·ª´ ti·ªÅn theo Voucher
- **Th√™m v√†o y√™u th√≠ch**: L∆∞u s·ª± ki·ªán v√†o Wishlist
- **Thanh to√°n tr·ª±c tuy·∫øn**: PayOS (Chuy·ªÉn kho·∫£n/QR Code)
- **Xu·∫•t v√© & QR Code**: T·ª± ƒë·ªông t·∫°o m√£ QR v√† g·ª≠i qua Email
- **H·ªßy v√© & Ho√†n ti·ªÅn**: G·ª≠i y√™u c·∫ßu ho√†n ti·ªÅn (trong 36h, ph√≠ h·ªßy 40%)
- **Danh s√°ch ch·ªù**: ƒêƒÉng k√Ω waitlist, nh·∫≠n th√¥ng b√°o khi c√≥ v√© tr·ªëng

#### üè¢ Qu·∫£n L√Ω S·ª± Ki·ªán (Organizer)
- **T·∫°o s·ª± ki·ªán**: Nh·∫≠p th√¥ng tin, upload ·∫£nh, ch·ªçn th·ªùi gian
- **Thi·∫øt l·∫≠p s∆° ƒë·ªì gh·∫ø**: C·∫•u h√¨nh lo·∫°i v√©, s·ªë l∆∞·ª£ng, v·ªã tr√≠ v√† gi√° ti·ªÅn
- **Qu·∫£n l√Ω Voucher**: T·∫°o m√£ gi·∫£m gi√° (% ho·∫∑c s·ªë ti·ªÅn c·ªë ƒë·ªãnh)
- **CRUD nh√¢n vi√™n**: Th√™m, s·ª≠a, x√≥a, t·∫°o t√†i kho·∫£n cho nh√¢n vi√™n so√°t v√©
- **G·ª≠i th√¥ng b√°o**: G·ª≠i tin nh·∫Øn/Email t·ªõi Customer ho·∫∑c Staff
- **Qu·∫£n l√Ω ƒë∆°n h√†ng**: Theo d√µi danh s√°ch kh√°ch ƒë√£ mua v√©
- **Xu·∫•t danh s√°ch**: Export file Excel danh s√°ch ng∆∞·ªùi tham d·ª±
- **B√°o c√°o & Analytics**: Bi·ªÉu ƒë·ªì doanh thu v√† t·ª∑ l·ªá l·∫•p ƒë·∫ßy gh·∫ø
- **G·ª£i √Ω gi√° v√© (AI)**: H·ªá th·ªëng g·ª£i √Ω m·ª©c gi√° d·ª±a tr√™n d·ªØ li·ªáu l·ªãch s·ª≠

#### ‚úÖ Check-in & X√°c Th·ª±c
- **ƒêƒÉng nh·∫≠p nh√¢n vi√™n**: Truy c·∫≠p h·ªá th·ªëng so√°t v√© (ch·ªâ quy·ªÅn Check-in)
- **Qu√©t m√£ QR**: S·ª≠ d·ª•ng Camera ƒëi·ªán tho·∫°i ƒë·ªÉ qu√©t v√© kh√°ch
- **X√°c th·ª±c & Check-in**: Ki·ªÉm tra th·∫≠t/gi·∫£ v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i v√©

#### üë®‚Äçüíº Qu·∫£n L√Ω S√†n (Admin)
- **Ph√™ duy·ªát s·ª± ki·ªán**: Ki·ªÉm duy·ªát n·ªôi dung tr∆∞·ªõc khi hi·ªÉn th·ªã
- **Qu·∫£n l√Ω ng∆∞·ªùi d√πng**: Qu·∫£n l√Ω danh s√°ch Organizer v√† Customer
- **ƒê·ªëi so√°t t√†i ch√≠nh**: T√≠nh ph√≠ s√†n (10%) v√† chuy·ªÉn ti·ªÅn cho Organizer
- **Qu·∫£n l√Ω khi·∫øu n·∫°i**: Duy·ªát ho·∫∑c t·ª´ ch·ªëi y√™u c·∫ßu ho√†n ti·ªÅn
- **Qu·∫£n l√Ω Banner**: C·∫•u h√¨nh qu·∫£ng c√°o, s·ª± ki·ªán n·ªïi b·∫≠t trang ch·ªß

#### ü§ñ T·ª± ƒê·ªông H√≥a (System)
- **G·ª≠i th√¥ng b√°o t·ª± ƒë·ªông**: Cronjob g·ª≠i mail nh·∫Øc s·ª± ki·ªán tr∆∞·ªõc 1 ng√†y
- **Thanh to√°n k√Ω qu·ªπ**: Gi·ªØ ti·ªÅn Resell, gi·∫£i ng√¢n sau khi check-in th√†nh c√¥ng

---

## üèóÔ∏è Ki·∫øn Tr√∫c D·ª± √Ån

```
EVENT-TICKETING-PLATFORM/
‚îú‚îÄ‚îÄ backend/                 # Backend API (Node.js + Express + TypeScript)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ express/         # Express routes, controllers, middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/         # Mongoose schemas
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/       # Business logic services
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts        # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ .env
‚îú‚îÄ‚îÄ frontend/                # Frontend (React + TypeScript + Vite)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/     # React components
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/          # Route pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contexts/       # React contexts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/          # Custom hooks
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.tsx        # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ vite.config.ts
‚îú‚îÄ‚îÄ shared/                  # Shared types between frontend & backend
‚îÇ   ‚îî‚îÄ‚îÄ types.ts
‚îî‚îÄ‚îÄ README.md
```

---

## üöÄ B·∫Øt ƒê·∫ßu

### Y√™u C·∫ßu H·ªá Th·ªëng

- Node.js >= 18.x
- npm ho·∫∑c yarn
- MongoDB (local ho·∫∑c MongoDB Atlas)
- T√†i kho·∫£n Cloudinary (cho upload ·∫£nh)
- T√†i kho·∫£n PayOS (cho thanh to√°n)
- Email service (cho g·ª≠i OTP, v√© QR Code)

### 1. Clone Repository

```bash
git clone <repository-url>
cd Event-Ticketing-Platform
```

### 2. C√†i ƒê·∫∑t Dependencies

#### Backend

```bash
cd backend
npm install
```

#### Frontend

```bash
cd frontend
npm install
```

### 3. C·∫•u H√¨nh Environment Variables

#### Backend (.env)

```env
# Database
MONGODB_CONNECTION_STRING=mongodb://localhost:27017/event-ticketing

# JWT
JWT_SECRET_KEY=your-secret-key

# Cloudinary
CLOUDINARY_CLOUD_NAME=your-cloud-name
CLOUDINARY_API_KEY=your-api-key
CLOUDINARY_API_SECRET=your-api-secret

# PayOS
PAYOS_CLIENT_ID=your-client-id
PAYOS_API_KEY=your-api-key
PAYOS_CHECKSUM_KEY=your-checksum-key
PAYOS_ENV=sandbox

# Email Service
EMAIL_SERVICE=sendgrid|nodemailer
EMAIL_API_KEY=your-email-api-key
EMAIL_FROM=noreply@eventticketing.com

# OAuth (Optional)
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
FACEBOOK_APP_ID=your-facebook-app-id
FACEBOOK_APP_SECRET=your-facebook-app-secret

# Server
PORT=7002
FRONTEND_URL=http://localhost:5174
```

#### Frontend (.env)

```env
VITE_API_BASE_URL=http://localhost:7002
```

### 4. Ch·∫°y ·ª®ng D·ª•ng

#### Backend

```bash
cd backend
npm run dev
```

Server s·∫Ω ch·∫°y t·∫°i `http://localhost:7002`

#### Frontend

```bash
cd frontend
npm run dev
```

·ª®ng d·ª•ng s·∫Ω m·ªü t·∫°i `http://localhost:5174`

---

## üìö API Documentation

API documentation c√≥ s·∫µn t·∫°i `/api-docs` khi ch·∫°y backend server.

### C√°c Endpoint Ch√≠nh

#### Authentication
- `POST /api/auth/register` - ƒêƒÉng k√Ω t√†i kho·∫£n
- `POST /api/auth/login` - ƒêƒÉng nh·∫≠p (Local/Google/Facebook)
- `POST /api/auth/logout` - ƒêƒÉng xu·∫•t
- `GET /api/auth/validate-token` - X√°c th·ª±c token
- `POST /api/auth/forgot-password` - Qu√™n m·∫≠t kh·∫©u
- `POST /api/auth/reset-password` - ƒê·∫∑t l·∫°i m·∫≠t kh·∫©u

#### User Management
- `GET /api/users/me` - L·∫•y th√¥ng tin user hi·ªán t·∫°i
- `PATCH /api/users/me` - C·∫≠p nh·∫≠t h·ªì s∆°
- `PATCH /api/users/me/password` - ƒê·ªïi m·∫≠t kh·∫©u
- `GET /api/users/wallet` - Xem v√≠ s·ªë d∆∞
- `POST /api/users/wallet/withdraw` - R√∫t ti·ªÅn

#### Event Discovery
- `GET /api/events` - T√¨m ki·∫øm s·ª± ki·ªán (t√™n, ng√†y, ƒë·ªãa ƒëi·ªÉm, th·ªÉ lo·∫°i)
- `GET /api/events/:eventId` - Xem chi ti·∫øt s·ª± ki·ªán
- `GET /api/events/:eventId/seats` - Xem s∆° ƒë·ªì gh·∫ø
- `GET /api/events/recommendations` - G·ª£i √Ω c√° nh√¢n h√≥a
- `GET /api/events/:eventId/view-360` - Xem ch·ªó ng·ªìi 360 ƒë·ªô

#### Booking & Payment
- `POST /api/bookings/reserve-seats` - Ch·ªçn & gi·ªØ gh·∫ø (5-10 ph√∫t)
- `POST /api/bookings/apply-voucher` - √Åp d·ª•ng m√£ gi·∫£m gi√°
- `POST /api/bookings` - T·∫°o ƒë∆°n h√†ng
- `POST /api/payments/create-payment-intent` - T·∫°o payment link (PayOS)
- `POST /api/bookings/:bookingId/cancel` - H·ªßy v√© & y√™u c·∫ßu ho√†n ti·ªÅn
- `POST /api/bookings/waitlist` - ƒêƒÉng k√Ω danh s√°ch ch·ªù

#### Organizer Management
- `POST /api/organizer/events` - T·∫°o s·ª± ki·ªán m·ªõi
- `GET /api/organizer/events` - Danh s√°ch s·ª± ki·ªán c·ªßa Organizer
- `PATCH /api/organizer/events/:eventId` - C·∫≠p nh·∫≠t s·ª± ki·ªán
- `POST /api/organizer/events/:eventId/seats` - Thi·∫øt l·∫≠p s∆° ƒë·ªì gh·∫ø
- `POST /api/organizer/vouchers` - T·∫°o Voucher
- `GET /api/organizer/bookings` - Qu·∫£n l√Ω ƒë∆°n h√†ng
- `GET /api/organizer/analytics` - B√°o c√°o & Analytics
- `POST /api/organizer/notifications` - G·ª≠i th√¥ng b√°o
- `GET /api/organizer/events/:eventId/export` - Xu·∫•t danh s√°ch kh√°ch (Excel)

#### Check-in App (Staff)
- `POST /api/staff/login` - ƒêƒÉng nh·∫≠p nh√¢n vi√™n
- `POST /api/staff/check-in/scan` - Qu√©t m√£ QR
- `POST /api/staff/check-in/face` - Check-in b·∫±ng FaceID
- `GET /api/staff/check-in/:bookingId` - X√°c th·ª±c v√©

#### Admin Management
- `GET /api/admin/events/pending` - Danh s√°ch s·ª± ki·ªán ch·ªù ph√™ duy·ªát
- `POST /api/admin/events/:eventId/approve` - Ph√™ duy·ªát s·ª± ki·ªán
- `GET /api/admin/users` - Qu·∫£n l√Ω ng∆∞·ªùi d√πng
- `GET /api/admin/financial/reconciliation` - ƒê·ªëi so√°t t√†i ch√≠nh
- `GET /api/admin/complaints` - Qu·∫£n l√Ω khi·∫øu n·∫°i
- `POST /api/admin/complaints/:id/resolve` - Duy·ªát/t·ª´ ch·ªëi ho√†n ti·ªÅn
- `GET /api/admin/banners` - Qu·∫£n l√Ω Banner
- `POST /api/admin/banners` - T·∫°o Banner m·ªõi

---

## üé® Tech Stack

### Backend

- **Node.js** - Runtime environment
- **Express** - Web framework
- **TypeScript** - Type safety
- **MongoDB** - Database
- **Mongoose** - ODM
- **JWT** - Authentication
- **PayOS** - Payment gateway
- **Cloudinary** - Image storage
- **Express Validator** - Input validation
- **Multer** - File upload
- **Nodemailer/SendGrid** - Email service
- **Socket.IO** - Real-time notifications
- **Node-cron** - Scheduled tasks

### Frontend

- **React 18** - UI library
- **TypeScript** - Type safety
- **Vite** - Build tool
- **Tailwind CSS** - Styling
- **React Query** - Server state management
- **Zustand** - Global state management
- **React Hook Form** - Form handling
- **Zod** - Schema validation
- **Axios** - HTTP client
- **React Router** - Routing
- **Lucide React** - Icons
- **QR Code Library** - Generate QR codes
- **Three.js** - 3D seat visualization (360 view)

---

## üë• Ph√¢n Quy·ªÅn Ng∆∞·ªùi D√πng

| Vai Tr√≤ | Quy·ªÅn H·∫°n |
|---------|-----------|
| **Customer** | T√¨m ki·∫øm s·ª± ki·ªán, ƒë·∫∑t v√©, thanh to√°n, xem l·ªãch s·ª≠ mua v√©, h·ªßy v√©, qu·∫£n l√Ω v√≠, ƒëƒÉng k√Ω waitlist, th√™m v√†o y√™u th√≠ch |
| **Organizer** | T·∫°o/qu·∫£n l√Ω s·ª± ki·ªán, thi·∫øt l·∫≠p s∆° ƒë·ªì gh·∫ø, qu·∫£n l√Ω Voucher, CRUD nh√¢n vi√™n, g·ª≠i th√¥ng b√°o, qu·∫£n l√Ω ƒë∆°n h√†ng, xu·∫•t danh s√°ch, xem Analytics, nh·∫≠n g·ª£i √Ω gi√° v√© AI |
| **Staff (Check-in)** | ƒêƒÉng nh·∫≠p h·ªá th·ªëng so√°t v√©, qu√©t m√£ QR, x√°c th·ª±c v√© |
| **Admin (S√†n)** | Ph√™ duy·ªát s·ª± ki·ªán, qu·∫£n l√Ω ng∆∞·ªùi d√πng, ƒë·ªëi so√°t t√†i ch√≠nh, qu·∫£n l√Ω khi·∫øu n·∫°i, qu·∫£n l√Ω Banner |

---

## üìù Use Cases (40 Use Cases)

### Module: Admin (S√†n)
1. **UC-37**: Ph√™ duy·ªát s·ª± ki·ªán
2. **UC-38**: Qu·∫£n l√Ω ng∆∞·ªùi d√πng
3. **UC-39**: ƒê·ªëi so√°t t√†i ch√≠nh (Ph√≠ s√†n 10%)
4. **UC-40**: Qu·∫£n l√Ω khi·∫øu n·∫°i (Duy·ªát/t·ª´ ch·ªëi ho√†n ti·ªÅn)
5. **UC-41**: Qu·∫£n l√Ω Banner

### Module: Auth
6. **UC-01**: ƒêƒÉng k√Ω t√†i kho·∫£n (OTP/Email)
7. **UC-02**: ƒêƒÉng nh·∫≠p/Logout (Local, Google, Facebook)
8. **UC-03**: Qu√™n m·∫≠t kh·∫©u

### Module: User Management
9. **UC-04**: C·∫≠p nh·∫≠t h·ªì s∆° (Avatar, th√¥ng tin c√° nh√¢n)
10. **UC-05**: ƒê·ªïi m·∫≠t kh·∫©u
11. **UC-44**: Qu·∫£n l√Ω v√≠ s·ªë d∆∞

### Module: Discovery
12. **UC-06**: T√¨m ki·∫øm & L·ªçc (T√™n, ng√†y, ƒë·ªãa ƒëi·ªÉm, th·ªÉ lo·∫°i - h·ªó tr·ª£ kh√¥ng d·∫•u)
13. **UC-07**: Xem chi ti·∫øt s·ª± ki·ªán
14. **UC-08**: G·ª£i √Ω c√° nh√¢n h√≥a
15. **UC-36**: Xem ch·ªó ng·ªìi 360 ƒë·ªô

### Module: Booking
16. **UC-09**: Ch·ªçn & Gi·ªØ gh·∫ø (Kh√≥a 5-10 ph√∫t, Race Condition)
17. **UC-11**: √Åp d·ª•ng m√£ gi·∫£m gi√°
18. **UC-12**: Th√™m v√†o y√™u th√≠ch
19. **UC-15**: H·ªßy v√© & Ho√†n ti·ªÅn (Trong 36h, ph√≠ 40%)
20. **UC-16**: ƒêƒÉng k√Ω danh s√°ch ch·ªù (Waitlist)

### Module: Payment
21. **UC-17**: Thanh to√°n tr·ª±c tuy·∫øn (PayOS)
22. **UC-18**: Xu·∫•t v√© & G·ª≠i QR (Email)

### Module: Customer Management
23. **UC-19**: L·ªãch s·ª≠ mua v√©

### Module: Event View
24. **UC-36**: Xem ch·ªó ng·ªìi 360 ƒë·ªô

### Module: Organizer
25. **UC-21**: ƒêƒÉng k√Ω/ƒêƒÉng nh·∫≠p Organizer
26. **UC-22**: T·∫°o m·ªõi s·ª± ki·ªán
27. **UC-23**: Thi·∫øt l·∫≠p s∆° ƒë·ªì gh·∫ø
28. **UC-24**: Qu·∫£n l√Ω Voucher
29. **UC-25**: CRUD nh√¢n vi√™n
30. **UC-26**: G·ª≠i th√¥ng b√°o (Global)
31. **UC-27**: Qu·∫£n l√Ω ƒë∆°n h√†ng
32. **UC-28**: Xu·∫•t danh s√°ch kh√°ch (Excel)
33. **UC-29**: B√°o c√°o & Analytics
34. **UC-30**: G·ª£i √Ω gi√° v√© (AI)

### Module: Check-in App
35. **UC-31**: ƒêƒÉng nh·∫≠p nh√¢n vi√™n
36. **UC-32**: Qu√©t m√£ QR (Scan)
37. **UC-33**: X√°c th·ª±c & Check-in

### Module: System
38. **UC-42**: G·ª≠i th√¥ng b√°o t·ª± ƒë·ªông (Cronjob)
39. **UC-43**: Thanh to√°n k√Ω qu·ªπ

---

## üß± H∆∞·ªõng d·∫´n thi·∫øt k·∫ø Microservice cho t·ª´ng nh√≥m Use Case

> M·ª•c ti√™u: gi√∫p team code theo ki·∫øn tr√∫c microservice (Node.js + Express + MongoDB/Mongoose), hi·ªÉu **service n√†o ch·ªãu tr√°ch nhi·ªám**, c·∫ßn **API/collection g√¨**, v√† **flow c∆° b·∫£n** cho t·ª´ng nh√≥m UC.

### 1. Ph√¢n chia service (logical)

- **API Gateway (4000)**: Route, auth JWT, RBAC, logging, rate limit.
- **Auth-Service (4001)**: UC-01, UC-02, UC-03, UC-04, UC-05, UC-21, UC-31  
  - Collections: `users`, `staffs`, `organizers`, `refreshTokens`, `otpTokens`.
- **Event-Service (4002)**: UC-06, UC-07, UC-08, UC-22, UC-23, UC-24, UC-27, UC-28, UC-29, UC-30, UC-36, UC-41  
  - Collections: `events`, `seatingPlans`, `vouchers`, `banners`, `analyticsSnapshots`, `priceSuggestions`.
- **Booking-Service (4003)**: UC-09, UC-11, UC-12, UC-15, UC-16, UC-18 (t·∫°o ticket record), UC-19, UC-31‚Äì33, UC-36 (map gh·∫ø v·ªõi ticket)  
  - Collections: `bookings`, `seatHolds`, `tickets`, `favorites`, `waitlists`, `refundRequests`.
- **Payment-Service (4004)**: UC-17, UC-39, UC-40 (li√™n quan ti·ªÅn), UC-42, UC-43, UC-44 (v√≠)
  - Collections: `wallets`, `transactions`, `payouts`, `escrows`, `paymentIntents`.
- (T√πy ch·ªçn) **Notification-Service**: G·ª≠i email/SMS (UC-18, UC-26, UC-42, UC-37/40).

---

### 2. Auth & User (UC-01 ‚Üí UC-05, UC-21, UC-31, UC-44)

- **Service**: `auth-service`
- **API ch√≠nh** (ƒë√£ list ·ªü ph·∫ßn API):
  - `POST /auth/register` (UC-01), `POST /auth/login` (UC-02), `POST /auth/logout`, `POST /auth/forgot-password` (UC-03),
    `PATCH /users/me` (UC-04), `PATCH /users/me/password` (UC-05), `GET /users/wallet` (UC-44), `POST /users/wallet/withdraw`.
- **Flow c∆° b·∫£n UC-01 (ƒêƒÉng k√Ω)**:
  1. API Gateway nh·∫≠n request ‚Üí check rate limit ‚Üí forward `POST /auth/register` sang `auth-service`.
  2. `auth-service`:
     - Validate email/password.
     - Hash password v·ªõi bcrypt.
     - T·∫°o `user` v·ªõi tr·∫°ng th√°i `PENDING`.
     - T·∫°o `otpToken` (code + expiredAt) v√† g·ª≠i email (g·ªçi Notification-Service).
  3. API `POST /auth/verify-otp` ‚Üí set user `ACTIVE`.
- **Flow v√≠ (UC-44)**:
  - `wallets` trong `payment-service`:
    - Schema ƒë∆°n gi·∫£n: `userId`, `balance`, `transactions[]`.
    - `GET /wallet` ƒë·ªçc t·ª´ `payment-service`.
    - `POST /wallet/withdraw` t·∫°o record `transactions` + enqueue job chuy·ªÉn ti·ªÅn th·ª±c t·∫ø (manual/PayOS).

---

### 3. Discovery & Search (UC-06, UC-07, UC-08, UC-36)

- **Service**: `event-service`
- **Collections**: `events`, `seatingPlans`, `recommendations`.

#### UC-06 ‚Äì T√¨m ki·∫øm & L·ªçc (c√≥ h·ªó tr·ª£ kh√¥ng d·∫•u)

- **√ù t∆∞·ªüng**:
  - Trong collection `events`, l∆∞u th√™m field ƒë√£ chu·∫©n h√≥a kh√¥ng d·∫•u:
    - `name`: "ƒê√™m nh·∫°c Tr·ªãnh C√¥ng S∆°n"
    - `nameNormalized`: "dem nhac trinh cong son"
  - Khi user search `"dem nhac"` ho·∫∑c `"dem nh·∫°c"` ƒë·ªÅu match.
- **C√°ch code (Node + Mongoose ‚Äì √Ω t∆∞·ªüng)**:

```ts
// utils/removeVietnameseTones.ts
export function removeVietnameseTones(str: string) {
  // C√≥ th·ªÉ d√πng th∆∞ vi·ªán ho·∫∑c t·ª± vi·∫øt map unicode ‚Üí kh√¥ng d·∫•u
  return str
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/ƒë/g, "d")
    .replace(/ƒê/g, "D")
    .toLowerCase();
}

// models/Event.ts
const EventSchema = new Schema({
  name: String,
  nameNormalized: { type: String, index: true },
  // ... c√°c field kh√°c: date, location, category...
});

EventSchema.pre("save", function (next) {
  if (this.isModified("name")) {
    this.nameNormalized = removeVietnameseTones(this.name);
  }
  next();
});

// controller search
export const searchEvents = async (req, res) => {
  const { q, date, location, category } = req.query;
  const filter: any = {};
  if (q) filter.nameNormalized = { $regex: removeVietnameseTones(q as string), $options: "i" };
  if (date) filter.date = { $gte: startOfDay(date), $lte: endOfDay(date) };
  if (location) filter.location = location;
  if (category) filter.category = category;

  const events = await EventModel.find(filter).limit(50);
  res.json(events);
};
```

#### UC-07 ‚Äì Xem chi ti·∫øt & s∆° ƒë·ªì gh·∫ø

- `GET /events/:id` ‚Üí tr·∫£ event + th√¥ng tin c∆° b·∫£n.
- `GET /events/:id/seats` ‚Üí tr·∫£ `seatingPlan` (rows, cols, zone, price, seatId).

#### UC-08 ‚Äì G·ª£i √Ω c√° nh√¢n h√≥a

- **Service**: `event-service` + ƒë·ªçc d·ªØ li·ªáu `bookings` t·ª´ `booking-service`.
- √ù t∆∞·ªüng ƒë∆°n gi·∫£n:
  - L·∫•y top 3 category user hay mua.
  - Recommend c√°c event s·∫Øp di·ªÖn ra trong category ƒë√≥, ch∆∞a h·∫øt v√©.

#### UC-36 ‚Äì Xem ch·ªó ng·ªìi 360¬∞

- L∆∞u trong `events`:
  - `view360Config`: `{ seatId, cameraPosition, cameraTarget, assetUrl }`.
- Frontend d√πng Three.js ho·∫∑c th∆∞ vi·ªán 3D ƒë·ªÉ render t·ª´ data n√†y.

---

### 4. Booking ‚Äì Gi·ªØ gh·∫ø, Wishlist, Voucher, Waitlist (UC-09, UC-11, UC-12, UC-15, UC-16)

- **Service**: `booking-service`
- **Collections ch√≠nh**: `bookings`, `seatHolds`, `favorites`, `vouchers` (share v·ªõi event-service ho·∫∑c ri√™ng), `waitlists`, `refundRequests`.

#### UC-09 ‚Äì Ch·ªçn & Gi·ªØ gh·∫ø (Race Condition, 5‚Äì10 ph√∫t)

- **M·ª•c ti√™u**:
  - Gh·∫ø ch·ªâ c√≥ th·ªÉ ƒë∆∞·ª£c gi·ªØ b·ªüi **1 booking** t·∫°i 1 th·ªùi ƒëi·ªÉm.
  - Gh·∫ø ƒë∆∞·ª£c **t·ª± ƒë·ªông nh·∫£** sau 5‚Äì10 ph√∫t n·∫øu ch∆∞a thanh to√°n.
- **Thi·∫øt k·∫ø DB**:
  - Collection `seatHolds`:
    - `eventId`, `seatId`, `userId`, `status: "HELD" | "CONFIRMED"`, `expiresAt`.
    - **TTL index** tr√™n `expiresAt` ƒë·ªÉ Mongo t·ª± x√≥a document h·∫øt h·∫°n.
    - **Unique index** tr√™n `eventId + seatId + status in ["HELD", "CONFIRMED"]` ƒë·ªÉ ch·ªëng double-book.
- **Flow API**:
  1. User ch·ªçn gh·∫ø ‚Üí `POST /bookings/reserve-seats`.
  2. `booking-service` m·ªü transaction:
     - V·ªõi m·ªói seat: `insertOne` v√†o `seatHolds` v·ªõi `status = "HELD"`, `expiresAt = now + 10 ph√∫t`.
     - N·∫øu duplicate key error ‚Üí gh·∫ø ƒë√£ b·ªã gi·ªØ/b√°n ‚Üí tr·∫£ l·ªói.
  3. Tr·∫£ v·ªÅ `holdId` + th·ªùi gian h·∫øt h·∫°n.
  4. Khi user b·∫•m thanh to√°n:
     - T·∫°o `booking` v·ªõi tr·∫°ng th√°i `PENDING_PAYMENT`, tham chi·∫øu c√°c `seatHolds`.
     - G·ªçi `payment-service` t·∫°o `paymentIntent`.
  5. Callback thanh to√°n th√†nh c√¥ng ‚Üí set `seatHolds.status = "CONFIRMED"` v√† `booking.status = "PAID"`.
  6. N·∫øu user h·ªßy thanh to√°n / h·∫øt th·ªùi gian:
     - Kh√¥ng c·∫≠p nh·∫≠t g√¨, `seatHolds` s·∫Ω t·ª± b·ªã TTL x√≥a ‚Üí coi nh∆∞ gh·∫ø ƒë∆∞·ª£c nh·∫£.

#### UC-11 ‚Äì √Åp d·ª•ng m√£ gi·∫£m gi√°

- `booking-service` g·ªçi sang `event-service`/`voucher-service`:
  - `GET /vouchers/validate?code=...&eventId=...&userId=...&amount=...`
  - Logic: check hi·ªáu l·ª±c, s·ªë l·∫ßn d√πng, min-order, lo·∫°i voucher (%, s·ªë ti·ªÅn).
  - Tr·∫£ v·ªÅ `discountAmount` ƒë·ªÉ `booking` t√≠nh total.

#### UC-12 ‚Äì Th√™m v√†o y√™u th√≠ch (Wishlist)

- Collection `favorites`:
  - `userId`, `eventId`, `createdAt`.
- API:
  - `POST /favorites` (add), `DELETE /favorites/:eventId`, `GET /favorites`.

#### UC-15 ‚Äì H·ªßy v√© & Ho√†n ti·ªÅn (36h, ho√†n 60%)

- **T√≠nh ph√≠**:
  - N·∫øu v√© 10k ‚Üí ho√†n 6k ‚Üí s√†n gi·ªØ 4k (40%).
- **Flow**:
  1. Customer g·ªçi `POST /bookings/:bookingId/cancel`.
  2. `booking-service`:
     - Check `booking.status === "PAID"` v√† `createdAt <= now - 36h` (kh√¥ng cho h·ªßy sau 36h).
     - T·∫°o `refundRequest` v·ªõi tr·∫°ng th√°i `PENDING_ADMIN`.
  3. Admin d√πng panel (UC-40) g·ªçi `POST /admin/complaints/:id/resolve`:
     - N·∫øu `APPROVE`: g·ª≠i request sang `payment-service`:
       - T√≠nh `refundAmount = ticketPrice * 0.6`.
       - Ghi `transaction` ho√†n ti·ªÅn (v·ªÅ v√≠ ho·∫∑c tr·∫£ qua PayOS).
       - Update `booking.status = "REFUNDED"`.
     - N·∫øu `REJECT`: update `refundRequest.status = "REJECTED"`.

#### UC-16 ‚Äì Danh s√°ch ch·ªù (Waitlist)

- Collection `waitlists`:
  - `eventId`, `userId`, `createdAt`, `status: "WAITING" | "NOTIFIED"`, `maxNotifyCount`.
- **2 tr∆∞·ªùng h·ª£p**:
  1. Event ch∆∞a m·ªü b√°n: user ƒëƒÉng k√Ω waitlist ‚Üí ƒë·∫øn th·ªùi ƒëi·ªÉm m·ªü b√°n (cron job) ‚Üí g·ª≠i email cho X ng∆∞·ªùi ƒë·∫ßu ti√™n.
  2. Event ƒë√£ sold-out: khi c√≥ v√© tr·ªëng l·∫°i (do refund/h·ªßy) ‚Üí trigger job g·ª≠i mail cho 1 batch user t·ª´ `waitlists`.

---

### 5. Payment ‚Äì Thanh to√°n, V√≠, ƒê·ªëi so√°t, K√Ω qu·ªπ (UC-17, UC-18, UC-39, UC-40, UC-42, UC-43, UC-44)

- **Service**: `payment-service`

#### UC-17 ‚Äì Thanh to√°n PayOS

- Flow:
  1. `booking-service` t·∫°o booking (PENDING_PAYMENT) ‚Üí g·ªçi `POST /payments/create-payment-create`.
  2. `payment-service`:
     - G·ªçi PayOS API t·∫°o link thanh to√°n.
     - L∆∞u `paymentStatus` v·ªõi `status = "PENDING"`.
  3. User thanh to√°n xong ‚Üí PayOS g·ªçi webhook `POST /payments/webhook`.
  4. `payment-service`:
     - X√°c minh checksum.
     - Update `paymentStatus.status = "SUCCEEDED"`.
     - G·ª≠i event (REST/kafka/nats) sang `booking-service` ƒë·ªÉ set `booking.status = "PAID"` v√† `seatHolds` th√†nh `CONFIRMED`.

#### UC-18 ‚Äì Xu·∫•t v√© & G·ª≠i QR

- C√≥ th·ªÉ ƒë·ªÉ trong `booking-service` (t·∫°o ticket) + `notification-service` (g·ª≠i email).
- Flow:
  - Khi `booking` chuy·ªÉn sang `PAID`:
    - T·∫°o `tickets` (m·ªói gh·∫ø 1 ticket, c√≥ `ticketId`, `qrCodePayload`).
    - D√πng lib QR t·∫°o ·∫£nh ‚Üí upload Cloudinary ‚Üí g·ª≠i email v·ªõi link/·∫£nh QR.

#### UC-39 ‚Äì ƒê·ªëi so√°t t√†i ch√≠nh (ph√≠ s√†n 10%)

- C√¥ng th·ª©c:
  - V·ªõi m·ªói booking `PAID`:  
    - `gross = totalAmount`  
    - `platformFee = gross * 0.10`  
    - `organizerShare = gross - platformFee`
- Thi·∫øt k·∫ø:
  - M·ªói `transaction` trong `payment-service` l∆∞u:
    - `bookingId`, `eventId`, `organizerId`, `gross`, `platformFee`, `organizerShare`, `type: "SALE" | "REFUND"`, `status`.
  - API cho Admin:
    - `GET /admin/financial/reconciliation?from=&to=&organizerId=`
      - Group by `organizerId`: sum `gross`, `platformFee`, `organizerShare`, `paidOut`.
  - Khi payout cho Organizer:
    - T·∫°o record `payouts` + gi·∫£m `wallet` c·ªßa h·ªá th·ªëng (ho·∫∑c ƒë√°nh d·∫•u `PAID_OUT`).

#### UC-40 ‚Äì Qu·∫£n l√Ω khi·∫øu n·∫°i (li√™n quan refund)

- ƒê√£ m√¥ t·∫£ ·ªü UC-15: `refundRequests` n·∫±m trong `booking-service`, nh∆∞ng khi duy·ªát c·∫ßn g·ªçi `payment-service` ƒë·ªÉ refund ti·ªÅn.

#### UC-42 ‚Äì G·ª≠i th√¥ng b√°o t·ª± ƒë·ªông

- Cronjob (d√πng `node-cron` ho·∫∑c service ri√™ng):
  - M·ªói ng√†y 1 l·∫ßn:
    - T√¨m event s·∫Ω di·ªÖn ra trong 24h.
    - Query `bookings` `PAID` cho event ƒë√≥.
    - G·ª≠i email "Nh·∫Øc l·ªãch s·ª± ki·ªán" cho kh√°ch.

#### UC-43 ‚Äì Thanh to√°n k√Ω qu·ªπ (Escrow)

- √Åp d·ª•ng cho v√© resell ho·∫∑c c√°c case c·∫ßn gi·ªØ ti·ªÅn ƒë·∫øn sau check-in.
- Flow:
  1. Trong thanh to√°n: thay v√¨ chuy·ªÉn to√†n b·ªô cho Organizer, ti·ªÅn ƒë∆∞·ª£c ƒë∆∞a v√†o `escrow`:
     - `escrows`: `bookingId`, `amount`, `status: "HELD" | "RELEASED" | "REFUNDED"`.
  2. Khi check-in th√†nh c√¥ng (UC-33/35):
     - `booking-service` g·ª≠i event sang `payment-service` ‚Üí `escrow.status = "RELEASED"` ‚Üí t·∫°o `payout` cho Organizer.
  3. N·∫øu v√© kh√¥ng d√πng / b·ªã report:
     - C√≥ th·ªÉ refund 1 ph·∫ßn/whole t√πy rule.

---

### 6. Organizer & Admin (UC-22‚Äì30, UC-37‚Äì41)

- **Organizer**:
  - T·∫•t c·∫£ API `/organizer/...` n√™n route qua API Gateway ‚Üí check role `ORGANIZER`.
  - CRUD s·ª± ki·ªán, s∆° ƒë·ªì gh·∫ø, voucher, nh√¢n vi√™n, ƒë∆°n h√†ng, export Excel, analytics, g·ª£i √Ω gi√° v√©.
- **Admin**:
  - Ph·∫ßn l·ªõn API ·ªü `admin-service` ho·∫∑c t√°ch trong `event-service` + `payment-service`:
    - Approve event (UC-37): set `event.status = "APPROVED"` ‚Üí m·ªõi cho hi·ªÉn th·ªã ·ªü search.
    - Qu·∫£n l√Ω user (UC-38): ƒë·ªçc t·ª´ `auth-service` + filter role.
    - ƒê·ªëi so√°t (UC-39): xem t·ª´ `payment-service`.
    - Khi·∫øu n·∫°i (UC-40): ƒë·ªçc `refundRequests` t·ª´ `booking-service`, g·ªçi `payment-service` khi duy·ªát.
    - Banner (UC-41): CRUD `banners` trong `event-service`.

---

### 7. G·ª£i √Ω gi√° v√© (AI) ‚Äì UC-30

- **√ù t∆∞·ªüng MVP** (ch∆∞a c·∫ßn ML ph·ª©c t·∫°p):
  - D·ª±a v√†o:
    - Lo·∫°i s·ª± ki·ªán, venue, l·ªãch s·ª≠ gi√° v√© c≈©, t·ª∑ l·ªá l·∫•p ƒë·∫ßy gh·∫ø, th·ªùi gian c√≤n l·∫°i ƒë·∫øn ng√†y di·ªÖn.
  - Simple rule:
    - N·∫øu event c√πng lo·∫°i, c√πng venue tr∆∞·ªõc ƒë√¢y c√≥ `occupancy > 90%` ‚Üí g·ª£i √Ω tƒÉng gi√° X%.
    - N·∫øu `occupancy < 50%` ·ªü c√°c l·∫ßn tr∆∞·ªõc ‚Üí g·ª£i √Ω gi·∫£m.
- L∆∞u k·∫øt qu·∫£ v√†o `priceSuggestions` trong `event-service` ƒë·ªÉ Organizer xem.

---

## üß™ Testing

### Test API v·ªõi Postman

Xem h∆∞·ªõng d·∫´n chi ti·∫øt t·∫°i [backend/TEST_APIS.md](./backend/TEST_APIS.md)

### Test Flow C∆° B·∫£n

1. ƒêƒÉng k√Ω t√†i kho·∫£n Customer
2. ƒêƒÉng nh·∫≠p v√† l·∫•y token
3. T√¨m ki·∫øm s·ª± ki·ªán
4. Ch·ªçn gh·∫ø v√† gi·ªØ ch·ªó
5. √Åp d·ª•ng Voucher (n·∫øu c√≥)
6. Thanh to√°n qua PayOS
7. Nh·∫≠n v√© QR Code qua Email
8. Check-in t·∫°i s·ª± ki·ªán (Staff qu√©t QR)

---

## üì¶ Scripts

### Backend

```bash
npm run dev      # Ch·∫°y development server
npm run build    # Build TypeScript
npm start        # Ch·∫°y production server
```

### Frontend

```bash
npm run dev      # Ch·∫°y development server (port 5174)
npm run build    # Build production
npm run preview  # Preview production build
npm run lint     # Lint code
```

---

## üîí Security

- JWT authentication
- Password hashing v·ªõi bcryptjs
- Input validation v·ªõi express-validator v√† Zod
- CORS configuration
- Helmet.js cho security headers
- Rate limiting
- Environment variables cho sensitive data
- QR Code encryption cho v√©
- Race Condition handling cho ƒë·∫∑t gh·∫ø

---

## üìÑ License

ISC

---

## üë®‚Äçüíª Author

**Email: de180577tranhongphuoc@gmail.com**
**Facebook: https://www.facebook.com/tran.hong.phuoc.947381/**

---

## üôè Acknowledgments

- PayOS - Payment gateway integration
- Cloudinary - Image storage service
- MongoDB Atlas - Cloud database
- React Query - Server state management
- Zustand - State management
- SendGrid/Nodemailer - Email service
- Socket.IO - Real-time notifications

---

*Built with ‚ù§Ô∏è using MERN Stack*
