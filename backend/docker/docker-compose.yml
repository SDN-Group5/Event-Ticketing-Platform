# Docker Compose - Event Ticketing Microservices
# Chạy: docker compose up -d --build
#
# TỐI ƯU CHO MÁY 8GB RAM:
# - Đã tắt MongoDB local (dùng MongoDB Atlas)
# - Đã tắt Redis (bật lại khi cần seat locking)
# - Chỉ chạy: API Gateway + Auth Service + Layout Service (~500-800MB RAM)

services:
  # ============================================
  # API GATEWAY (Port 4000)
  # ============================================
  api-gateway:
    build:
      context: ../services/api-gateway
      dockerfile: Dockerfile
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=development
      - PORT=4000
      - AUTH_SERVICE_URL=http://auth-service:4001
      - EVENT_SERVICE_URL=http://event-service:4002
      - BOOKING_SERVICE_URL=http://booking-service:4003
      - PAYMENT_SERVICE_URL=http://payment-service:4004
      - FRONTEND_URL=http://localhost:3000
    depends_on:
      - auth-service
    networks:
      - ticketing-network
    restart: unless-stopped

  # ============================================
  # LAYOUT SERVICE (Port 4002)
  # ============================================
  layout-service:
    build:
      context: ../services/layout-service
      dockerfile: Dockerfile
    ports:
      - "4002:4002"
    environment:
      - PORT=4002
      - MONGODB_URI=${MONGODB_ATLAS_URI:-mongodb://host.docker.internal:27017/Ticket}
    networks:
      - ticketing-network
    restart: unless-stopped

  # ============================================
  # PAYMENT SERVICE (Port 4004)
  # ============================================
  payment-service:
    build:
      context: ../services/payment-service
      dockerfile: Dockerfile
    env_file:
      - ../.env
    ports:
      - "4004:4004"
    environment:
      - NODE_ENV=development
      - PAYMENT_SERVICE_PORT=4004
    networks:
      - ticketing-network
    restart: unless-stopped

  # ============================================
  # AUTH SERVICE (Port 4001)
  # ============================================
  auth-service:
    build:
      context: ../services/auth-service
      dockerfile: Dockerfile
    ports:
      - "4001:4001"
    environment:
      - NODE_ENV=development
      - PORT=4001
      # Dùng MongoDB Atlas (cloud) - không cần MongoDB local
      # Lấy từ file .env hoặc env file
      - MONGODB_URI=${MONGODB_ATLAS_URI}
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-secret-key-change-me}
    # Không cần depends_on mongodb nữa vì dùng Atlas
    networks:
      - ticketing-network
    restart: unless-stopped

  # ============================================
  # MONGODB (ĐÃ TẮT - Dùng MongoDB Atlas thay thế)
  # ============================================
  # Tiết kiệm ~200-300MB RAM cho máy 8GB
  # mongodb:
  #   image: mongo:7
  #   ports:
  #     - "27017:27017"
  #   volumes:
  #     - mongodb_data:/data/db
  #   networks:
  #     - ticketing-network
  #   healthcheck:
  #     test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 10s
  #   restart: unless-stopped

  # ============================================
  # REDIS (ĐÃ TẮT - Tiết kiệm RAM cho máy 8GB)
  # ============================================
  # Bật lại khi cần tính năng giữ ghế (seat locking)
  # redis:
  #   image: redis:7-alpine
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   networks:
  #     - ticketing-network
  #   restart: unless-stopped

# ============================================
# NETWORKS
# ============================================
networks:
  ticketing-network:
    driver: bridge

# ============================================
# VOLUMES (Đã xóa vì không dùng MongoDB và Redis local)
# ============================================
# Bật lại khi cần MongoDB hoặc Redis local:
# volumes:
#   mongodb_data:
#   redis_data:
